<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZingMp3 API</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #fff;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      animation: fadeIn 0.6s ease-out;
    }

    .header h1 {
      font-size: 48px;
      font-weight: 700;
      background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
      letter-spacing: -1px;
    }

    .header p {
      color: rgba(255,255,255,0.8);
      font-size: 16px;
    }

    .search-box {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      animation: slideUp 0.6s ease-out;
    }

    .search-input {
      width: 100%;
      padding: 18px 24px;
      border-radius: 50px;
      border: 2px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 18px;
      outline: none;
      transition: all 0.3s;
      margin-bottom: 16px;
    }

    .search-input::placeholder {
      color: rgba(255,255,255,0.6);
    }

    .search-input:focus {
      border-color: rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.15);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .btn {
      padding: 16px 40px;
      border-radius: 50px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-block;
      text-align: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      box-shadow: 0 4px 15px rgba(102,126,234,0.4);
      width: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(102,126,234,0.5);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .result-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
      animation: fadeIn 0.6s ease-out;
    }

    .card {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .card h2 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #fff;
      font-weight: 600;
    }

    .song-info {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .thumbnail {
      width: 100%;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      margin-bottom: 16px;
    }

    .info-item {
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 6px;
      font-weight: 600;
    }

    .info-value {
      font-size: 16px;
      color: #fff;
      font-weight: 500;
    }

    .lyrics-box {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
      line-height: 1.8;
      color: rgba(255,255,255,0.9);
      white-space: pre-wrap;
      font-size: 15px;
    }

    .lyrics-box::-webkit-scrollbar {
      width: 8px;
    }

    .lyrics-box::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
    }

    .lyrics-box::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.3);
      border-radius: 10px;
    }

    .lyrics-box::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.5);
    }

    .player-controls {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-play {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: #fff;
      flex: 1;
      min-width: 140px;
    }

    .btn-play:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245,87,108,0.4);
    }

    audio {
      width: 100%;
      margin-top: 16px;
      border-radius: 12px;
      outline: none;
    }

    .hidden {
      display: none !important;
    }

    .loader {
      text-align: center;
      padding: 40px;
      color: rgba(255,255,255,0.8);
      font-size: 16px;
    }

    .loader::after {
      content: "...";
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: "."; }
      40% { content: ".."; }
      60%, 100% { content: "..."; }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .error-message {
      background: rgba(239,68,68,0.2);
      border: 1px solid rgba(239,68,68,0.4);
      color: #fff;
      padding: 16px 20px;
      border-radius: 12px;
      margin-top: 20px;
      text-align: center;
    }

    @media (max-width: 768px) {
      .result-container {
        grid-template-columns: 1fr;
      }

      .header h1 {
        font-size: 36px;
      }

      .search-box {
        padding: 20px;
      }

      .card {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéµ ZingMP3</h1>
      <p>T√¨m ki·∫øm v√† nghe nh·∫°c y√™u th√≠ch</p>
    </div>

    <div class="search-box">
      <input 
        type="text" 
        id="searchInput" 
        class="search-input" 
        placeholder="Nh·∫≠p t√™n b√†i h√°t, ca sƒ©..."
        autofocus
      />
      <button class="btn btn-primary" onclick="search()">T√¨m ki·∫øm</button>
    </div>

    <div id="resultContainer" class="result-container hidden">
      <!-- Th√¥ng tin b√†i h√°t -->
      <div class="card">
        <h2>üìÄ Th√¥ng tin b√†i h√°t</h2>
        <div class="song-info">
          <img id="thumbnail" class="thumbnail hidden" alt="Thumbnail" />
          
          <div class="info-item">
            <div class="info-label">T√™n b√†i h√°t</div>
            <div class="info-value" id="songTitle">-</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">Ca sƒ©</div>
            <div class="info-value" id="songArtist">-</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">Th·ªùi l∆∞·ª£ng</div>
            <div class="info-value" id="songDuration">-</div>
          </div>

          <div class="player-controls">
            <button class="btn btn-play" onclick="playAudio()">‚ñ∂ Ph√°t nh·∫°c</button>
          </div>

          <audio id="audioPlayer" controls class="hidden"></audio>
        </div>
      </div>

      <!-- L·ªùi b√†i h√°t -->
      <div class="card">
        <h2>üìù L·ªùi b√†i h√°t</h2>
        <div id="lyricsBox" class="lyrics-box">
          <div class="loader">ƒêang t·∫£i l·ªùi b√†i h√°t</div>
        </div>
      </div>
    </div>

    <div id="errorMessage" class="error-message hidden"></div>
  </div>

  <script>
    const searchInput = document.getElementById('searchInput');
    const resultContainer = document.getElementById('resultContainer');
    const errorMessage = document.getElementById('errorMessage');
    const thumbnail = document.getElementById('thumbnail');
    const songTitle = document.getElementById('songTitle');
    const songArtist = document.getElementById('songArtist');
    const songDuration = document.getElementById('songDuration');
    const lyricsBox = document.getElementById('lyricsBox');
    const audioPlayer = document.getElementById('audioPlayer');

    let currentSongId = null;

    // Detect base URL for Ingress support
    function getBaseUrl() {
      const path = window.location.pathname;
      if (path === '/' || path === '/index.html') {
        return '';
      }
      return path.replace(/\/$/, '');
    }

    const BASE_URL = getBaseUrl();

    async function apiCall(path, params) {
      let urlPath = BASE_URL + path;
      const queryString = params ? '?' + new URLSearchParams(params).toString() : '';
      const fullUrl = urlPath + queryString;
      
      const res = await fetch(fullUrl);
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`HTTP ${res.status}: ${text}`);
      }
      return res.json();
    }

    function formatDuration(seconds) {
      if (!seconds) return 'N/A';
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function showError(msg) {
      errorMessage.textContent = msg;
      errorMessage.classList.remove('hidden');
      resultContainer.classList.add('hidden');
    }

    function hideError() {
      errorMessage.classList.add('hidden');
    }

    async function search() {
      const query = searchInput.value.trim();
      if (!query) {
        showError('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm');
        return;
      }

      hideError();
      resultContainer.classList.add('hidden');

      try {
        // T√¨m ki·∫øm
        const searchData = await apiCall('/api/search', { q: query });
        
        const songs = searchData?.data?.items?.filter(i => i.resourceType === 'song') || 
                      searchData?.data?.songs || [];

        if (!songs.length) {
          showError('üòî Kh√¥ng t√¨m th·∫•y b√†i h√°t n√†o');
          return;
        }

        // L·∫•y b√†i ƒë·∫ßu ti√™n
        const firstSong = songs[0];
        currentSongId = firstSong.encodeId || firstSong.id;

        // Hi·ªÉn th·ªã th√¥ng tin c∆° b·∫£n
        songTitle.textContent = firstSong.title || 'Kh√¥ng r√µ';
        songArtist.textContent = firstSong.artistsNames || 'Kh√¥ng r√µ';
        songDuration.textContent = formatDuration(firstSong.duration);

        if (firstSong.thumbnail || firstSong.thumbnailM) {
          thumbnail.src = firstSong.thumbnail || firstSong.thumbnailM;
          thumbnail.classList.remove('hidden');
        } else {
          thumbnail.classList.add('hidden');
        }

        // Hi·ªÉn th·ªã container
        resultContainer.classList.remove('hidden');

        // Load l·ªùi b√†i h√°t
        loadLyrics(currentSongId);

        // Setup audio player
        const proxyUrl = `${BASE_URL}/proxy_audio?id=${encodeURIComponent(currentSongId)}`;
        audioPlayer.src = proxyUrl;

      } catch (e) {
        showError(`‚ùå L·ªói: ${e.message}`);
      }
    }

    async function loadLyrics(songId) {
      lyricsBox.innerHTML = '<div class="loader">ƒêang t·∫£i l·ªùi b√†i h√°t</div>';

      try {
        const lyricData = await apiCall('/api/lyric', { id: songId });
        const fileUrl = lyricData?.data?.file;

        if (fileUrl) {
          const resp = await fetch(fileUrl);
          const lrcText = await resp.text();
          
          // Parse LRC v√† b·ªè timestamp
          const cleanLyrics = lrcText
            .split('\n')
            .map(line => line.replace(/\[\d{2}:\d{2}.\d{2,3}\]/g, '').trim())
            .filter(line => line.length > 0)
            .join('\n');

          lyricsBox.textContent = cleanLyrics || 'Kh√¥ng c√≥ l·ªùi b√†i h√°t';
        } else {
          lyricsBox.textContent = 'Kh√¥ng t√¨m th·∫•y l·ªùi b√†i h√°t';
        }
      } catch (e) {
        lyricsBox.textContent = 'Kh√¥ng th·ªÉ t·∫£i l·ªùi b√†i h√°t';
      }
    }

    function playAudio() {
      if (!audioPlayer.src) return;
      
      audioPlayer.classList.remove('hidden');
      audioPlayer.play();
    }

    // Enter key ƒë·ªÉ search
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        search();
      }
    });
  </script>
</body>
</html>
